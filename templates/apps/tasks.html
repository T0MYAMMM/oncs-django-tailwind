{% extends "layouts/base.html" %}

{% load formats file_extension info_value %}


{% block content %}
<main>
  <div class="px-4 pt-6">

  <div class="container mx-auto max-w-full mx-auto">

    <!-- Info component -->
    <div class="flex flex-wrap ">
      <div class="w-full">
        <div class="border mb-4 dark:bg-gray-800 dark:border-gray-600 rounded-lg dark:text-white">
          <div class="py-3 rounded-t-lg px-3 mb-0 bg-gray-200 border-b-1 border-gray-300 text-gray-900 bg-gray-100 dark:bg-gray-700 dark:text-white px-4">
            <h6 class="">
              Async Tasks Manager
            </h6>
          </div>
          <div class="flex-auto p-6 px-0 pt-0 pb-2 px-4 mt-3">
            
            {% if scripts %}
              <p>
                Superusers are able to create/cancel tasks.
                <br />
                Ordinary users can only view execution logs and running tasks (no other interactions allowed).
              </p>
            {% else %}
              <p class="text-red-600">
                No scripts detected - Please update the configuration (CELERY_SCRIPTS_DIR, CELERY_LOGS_DIR)
              </p>
            {% endif %}
          
          </div>
        </div>
      </div>
    </div>
    
    <!-- Crawler Task Management Component -->
    <div class="flex flex-wrap ">
      <div class="w-full">
        <div class="border mb-4 dark:bg-gray-800 dark:border-gray-600 rounded-lg">
          <div class="py-3 rounded-t-lg dark:bg-gray-800 dark:text-white px-4">
            <h6>Crawler Task Management</h6>
          </div>
          <div class="flex-auto p-6 px-0 pt-0">
            
            <!-- Create Crawler Task Form -->
            <div class="mb-6">
              <h6 class="text-sm font-medium text-gray-900 dark:text-white mb-3">Create New Crawler Task</h6>
              <form action="{% url 'tasks:create-crawler-task' %}" method="post" class="flex gap-4 items-end">
                {% csrf_token %}
                <div class="flex-1">
                  <label for="crawler_config" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Crawler Config</label>
                  <select name="crawler_config" id="crawler_config" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <option value="">Select crawler config</option>
                    {% for config in crawler_configs %}
                      <option value="{{ config.pk }}">{{ config.name }} ({{ config.portal.name }})</option>
                    {% endfor %}
                  </select>
                </div>
                <button type="submit" 
                  class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                  Create & Execute Task
                </button>
              </form>
            </div>

            <!-- Create Scheduled Task Form -->
            <div class="mb-6">
              <h6 class="text-sm font-medium text-gray-900 dark:text-white mb-3">Create New Scheduled Task</h6>
              <form action="{% url 'tasks:create-scheduled-crawler-task' %}" method="post" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {% csrf_token %}
                <div>
                  <label for="scheduled_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Name</label>
                  <input type="text" name="name" id="scheduled_name" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                    placeholder="Daily News Crawl">
                </div>
                <div>
                  <label for="scheduled_crawler_config" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Crawler Config</label>
                  <select name="crawler_config" id="scheduled_crawler_config" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <option value="">Select crawler config</option>
                    {% for config in crawler_configs %}
                      <option value="{{ config.pk }}">{{ config.name }} ({{ config.portal.name }})</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label for="cron_expression" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cron Expression</label>
                  <input type="text" name="cron_expression" id="cron_expression" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                    placeholder="0 0 * * *">
                </div>
                <div class="flex items-end">
                  <button type="submit" 
                    class="w-full px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
                    Create Scheduled Task
                  </button>
                </div>
              </form>
            </div>

            <!-- Crawler Tasks Table -->
            <div class="mb-6">
              <h6 class="text-sm font-medium text-gray-900 dark:text-white mb-3">Recent Crawler Tasks</h6>
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                  <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">ID</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Config</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Portal</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Status</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Created</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Actions</th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                    {% for task in crawler_tasks %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">{{ task.id }}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">{{ task.crawler_config.name }}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">{{ task.crawler_config.portal.name }}</td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        {% if task.status == 'pending' %}
                          <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">Pending</span>
                        {% elif task.status == 'running' %}
                          <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">Running</span>
                        {% elif task.status == 'completed' %}
                          <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Completed</span>
                        {% elif task.status == 'failed' %}
                          <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">Failed</span>
                        {% endif %}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">{{ task.created_at|date:"M d, Y H:i" }}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        {% if task.status == 'pending' %}
                          <form action="{% url 'tasks:execute-crawler-task' task.id %}" method="post" class="inline">
                            {% csrf_token %}
                            <button type="submit" class="text-primary-600 hover:text-primary-900 dark:text-primary-400 dark:hover:text-primary-300">Execute</button>
                          </form>
                        {% endif %}
                      </td>
                    </tr>
                    {% empty %}
                    <tr>
                      <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">No crawler tasks found</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Scheduled Tasks Table -->
            <div class="mb-6">
              <h6 class="text-sm font-medium text-gray-900 dark:text-white mb-3">Scheduled Tasks</h6>
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                  <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Name</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Config</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Cron Expression</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Status</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Last Run</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Actions</th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                    {% for scheduled_task in scheduled_tasks %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">{{ scheduled_task.name }}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">{{ scheduled_task.crawler_config.name }}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white"><code class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">{{ scheduled_task.cron_expression }}</code></td>
                      <td class="px-6 py-4 whitespace-nowrap">
                        {% if scheduled_task.is_active %}
                          <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Active</span>
                        {% else %}
                          <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200">Inactive</span>
                        {% endif %}
                      </td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">{{ scheduled_task.last_run|default:"Never"|date:"M d, Y H:i" }}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        {% if scheduled_task.is_active %}
                          <form action="{% url 'tasks:execute-scheduled-crawler-task' scheduled_task.id %}" method="post" class="inline">
                            {% csrf_token %}
                            <button type="submit" class="text-primary-600 hover:text-primary-900 dark:text-primary-400 dark:hover:text-primary-300">Execute Now</button>
                          </form>
                        {% endif %}
                      </td>
                    </tr>
                    {% empty %}
                    <tr>
                      <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">No scheduled tasks found</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
    
    <!-- Task Manager Component -->
    <div class="flex flex-wrap ">
      <div class="w-full">
        <div class="border mb-4 dark:bg-gray-800 dark:border-gray-600 rounded-lg">
          <div class="py-3 rounded-t-lg dark:bg-gray-800 dark:text-white px-4">
            <h6>Tasks List</h6>
          </div>
          <div class="flex-auto p-6 px-0 pt-0">
            <div class="block w-full overflow-auto scrolling-touch p-0">
              <table class="min-w-full divide-y divide-gray-200 table-fixed dark:divide-gray-600">
                <thead class="bg-gray-100 dark:bg-gray-700"> 
                  <tr>
                    <th class="p-4 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400">Name</th>
                    <th class="p-4 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400">Script</th>
                    <th class="p-4 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400">STATE</th>
                    <th class="p-4 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400">
                      Script
                    </th>
                    <th class="p-4 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400">
                      ARGS
                    </th>                   
                    {% if request.user.is_superuser %}
                    <th class="p-4 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400">Action</th>
                    {% endif %}
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">

                  <!-- Running Task -->
                  {% for task in  tasks %}    

                  {% if task.status == "STARTED" %}
                  <form action="{% url 'tasks:cancel-task' task.id %}" method="post">
                  {% else %}
                  <form action="{% url 'tasks:run-task' task.name %}" method="post">                      
                  {% endif %}  

                  
                    {% csrf_token %}
                    <tr class="hover:bg-gray-100 dark:hover:bg-gray-700">
                      <td class="p-4 text-base font-medium text-gray-900 whitespace-nowrap dark:text-white">
                        <div class="flex px-2 py-1">
                          <div class="mx-3">
                            <i class="fa fa-file-code-o fa-2x"></i>
                          </div>
                          <div class="flex flex-col justify-center">
                            <h6 class="mb-0 text-sm">
                              {{task.name}}
                            </h6>
                            <p class="text-xs text-gray-600 mb-0 dark:text-gray-400">
                              Celery Task
                            </p>
                          </div>
                        </div>
                      </td>
                      <td class="p-4 text-base font-medium text-gray-900 whitespace-nowrap dark:text-white">
                        <p class="text-xs font-bold mb-0 ">
                          {{ task.script }}
                        </p>
                        <div class="text-xs text-gray-600 mb-0 dark:text-gray-400" >
                          Latest status: {{ task.status }}
                        </div>                          
                      </td>
                      <td class="p-4 text-base font-medium text-gray-900 whitespace-nowrap dark:text-white">
                        <span class="text-gray-600 text-xs font-bold">
                          {% if task.status == "STARTED" %}
                            <span class="text-blue-600">RUNNING</span>
                          {% elif task.status == "SUCCESS" %}
                            <span class="text-green-600">SUCCESS</span>
                          {% elif task.status == "FAILURE" %}
                            <span class="text-red-600">FAILURE</span>
                          {% else %}
                            <span class="text-gray-600">{{ task.status }}</span>
                          {% endif %}
                        </span>
                      </td>
                      <td class="p-4 text-base font-medium text-gray-900 whitespace-nowrap dark:text-white">
                        <span class="text-gray-600 text-xs font-bold">
                          
                          {% if task.name == 'execute_script' %}

                            <select class=" w-full py-1 px-2 mb-1 border border-gray-200 rounded dark:border-gray-600 dark:bg-gray-700 dark:text-white" name="script" 
                            {% if task.status == "STARTED" or not scripts %}
                              disabled
                            {% endif %}
                            >
                              {% for item in scripts %}
                                <option value="{{item}}" {% if item == task.input %}selected{% endif %}>{{ item }}</option>
                              {% endfor %}
                            </select>
                          
                          {% else %}
                            NA
                          {% endif %}
                          
                        </span>
                      </td>
                      <td class="p-4 text-base font-medium text-gray-900 whitespace-nowrap dark:text-white">
                        <span class="text-gray-600 text-xs font-bold">
                          <input class="block appearance-none w-full py-1 px-2 mb-1 text-base leading-normal bg-white text-gray-800 border border-gray-200 dark:border-gray-600 rounded bg-gray-100 dark:bg-gray-700 dark:text-white" type="text" id="args" name="args">
                        </span>
                      </td>

                      {% if request.user.is_superuser %}
                      <td class="p-4 text-base font-medium text-gray-900 whitespace-nowrap dark:text-white">

                        {% if task.status == "STARTED" %}

                          <button href="javascript:;" class="text-red-600 font-bold text-xs" data-toggle="tooltip" data-original-title="Edit user">
                            Cancel Task
                          </button>

                        {% elif task.status == "FAILURE" or task.status == "REVOKED" %}
                            
                            <button href="javascript:;" 
                                    class="dark:text-white text-gray-600 font-bold text-xs" data-toggle="tooltip" data-original-title="Edit user">
                              Execute
                            </button>

                        {% else %}                               
                          
                            <button href="javascript:;" 
                                    class="text-gray-600 font-bold text-xs" data-toggle="tooltip" data-original-title="Edit user">
                              Execute
                            </button>

                        {% endif %}

                      </td>
                      {% endif %}
                    </tr>

                  </form>
                {% endfor %}

                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Task Logs -->
    <div class="flex flex-wrap ">
      <div class="w-full">
        <div class="border mb-4 dark:bg-gray-800 dark:border-gray-600 rounded-lg">
          <div class="rounded-t-lg py-3 dark:bg-gray-800 dark:text-white px-4">
            <h6>
              LOGS
            </h6>
          </div>
          <div class="flex-auto px-0 pt-0 pb-2">
            <div class="block w-full overflow-auto scrolling-touch p-0">
              <table class="min-w-full divide-y divide-gray-200 table-fixed dark:divide-gray-600">
                <thead class="bg-gray-100 dark:bg-gray-700">
                  <tr>
                    <th class="p-4 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400">Task</th>
                    <th class="p-4 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400">Input</th>
                    <th class="p-4 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400">Status</th>
                    <th class="p-4 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400">Start TS</th>
                    <th class="p-4 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400">End TS</th>
                    <th class="p-4 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400">Output</th>
                    <th class="p-4 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400">Logs</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                  {% for result in task_results %}
                    <tr class="hover:bg-gray-100 dark:hover:bg-gray-700">

                      <td class="p-4 text-base font-medium text-gray-900 whitespace-nowrap dark:text-white">
                        <div class="flex px-2">
                          <div class="my-auto">
                            <h6 class="mb-0 text-sm">
                              {{result.id}} - {{result.task_name}}
                            </h6>
                            <p class="text-xs text-gray-600 mb-0">
                              {{result.task_id}}
                            </p>
                          </div>
                        </div>
                      </td>

                      <td class="p-4 text-base font-medium text-gray-900 whitespace-nowrap dark:text-white">
                        <p class="text-sm mb-0">{{result|get_result_field:"input"}}</p>
                      </td>

                      <td class="p-4 text-base font-medium text-gray-900 whitespace-nowrap dark:text-white">
                        <p class="text-sm 
                          {% if result|get_result_field:"status" == 'SUCCESS' %} text-success
                          {% elif result|get_result_field:"status" == 'FAILURE' %} text-danger
                          {% else %} text-warning {% endif %}
                          text-center mb-0"
                        >
                        {% if result|get_result_field:"status" %}
                          {{result|get_result_field:"status"}}
                        {% else %}
                          RUNNING
                        {% endif %}
                        </p>
                      </td>
                      
                      <td class="p-4 text-base font-medium text-gray-900 whitespace-nowrap dark:text-white">
                        <p class="text-sm mb-0">{{result.date_created|date:"M d, Y H:i"}}</p>
                      </td>

                      <td class="p-4 text-base font-medium text-gray-900 whitespace-nowrap dark:text-white">
                        <p class="text-sm mb-0">{{result.date_done|date:"M d, Y H:i"}}</p>
                      </td>

                      <td class="p-4 text-base font-medium text-gray-900 whitespace-nowrap dark:text-white">
                        <p class="text-sm mb-0">{{result|get_result_field:"output"}}</p>
                      </td>

                      <td class="p-4 text-base font-medium text-gray-900 whitespace-nowrap dark:text-white">
                        <p class="text-sm mb-0">
                          {% if result|get_result_field:"log_file" %}
                            <a href="{% url 'tasks:download_log_file' result|get_result_field:'log_file'|split:'/'|last %}" 
                               class="text-primary-600 hover:text-primary-900 dark:text-primary-400 dark:hover:text-primary-300">
                              Download Log
                            </a>
                          {% else %}
                            N/A
                          {% endif %}
                        </p>
                      </td>

                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <div class="modal opacity-0" 
       id="log-modal" tabindex="-1" role="dialog" aria-labelledby="modal-default" aria-hidden="true">
    <div class="modal-dialog modal- modal-dialog-centered modal-" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title mx-auto" id="modal-title-default">
            Task LOG
          </h6>
        </div>
        <div class="modal-body">
          <p id="log-content">
          </p>
        </div>
        <div class="modal-footer text-center">
          <button type="button" class="inline-block align-middle text-center select-none border font-normal whitespace-no-wrap rounded py-1 px-3 leading-normal no-underline font-normal text-blue-700 bg-transparent mx-auto" data-bs-dismiss="modal">Dismiss</button>
        </div>
      </div>
    </div>
  </div>  
</div>
</main>

{% endblock content %}